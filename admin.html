<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ™‚åˆ»è¡¨ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  | eã‚‹ã‚Šãã‚…ã†</title>
  <link rel="icon" href="images/favicon.svg" type="image/svg+xml">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&family=Cormorant+Garamond:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
  <style>
    *, *::before, *::after { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; overflow: hidden; }
    body {
      display: flex;
      flex-direction: column;
      background: var(--color-bg);
      font-family: 'Noto Serif JP', serif;
      color: var(--color-text);
    }

    /* â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .adm-header {
      background: var(--color-primary);
      color: #fff;
      padding: 10px 20px;
      display: flex;
      align-items: center;
      gap: 16px;
      flex-shrink: 0;
      border-bottom: 3px solid var(--color-accent);
    }
    .adm-header-title { font-size: 1rem; font-weight: 700; letter-spacing: 0.04em; }
    .adm-header-sub   { font-size: 0.7rem; opacity: 0.55; margin-bottom: 2px; }
    .adm-header-right { margin-left: auto; display: flex; align-items: center; gap: 14px; }
    .save-status      { font-size: 0.76rem; color: rgba(255,255,255,0.6); }

    /* â”€â”€ LAYOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .adm-body { display: flex; flex: 1; overflow: hidden; }

    /* â”€â”€ SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .adm-sidebar {
      width: 256px;
      flex-shrink: 0;
      background: #fff;
      border-right: 1px solid var(--color-border);
      display: flex;
      flex-direction: column;
    }
    .sidebar-top {
      padding: 11px 14px;
      border-bottom: 1px solid var(--color-border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .sidebar-top h2 { font-size: 0.83rem; margin: 0; }
    .sidebar-list { overflow-y: auto; flex: 1; }

    .train-item {
      padding: 10px 14px;
      border-bottom: 1px solid var(--color-border);
      cursor: pointer;
      border-left: 3px solid transparent;
      transition: background 0.1s;
    }
    .train-item:hover  { background: var(--color-bg); }
    .train-item.active { background: #eaf0f9; border-left-color: var(--color-primary); }
    .train-item-name   { font-size: 0.83rem; font-weight: 600; display: flex; align-items: center; gap: 6px; }
    .train-item-meta   { font-size: 0.71rem; color: var(--color-text-light); margin-top: 3px; }

    .type-pill { display: inline-block; font-size: 0.66rem; padding: 1px 5px; border-radius: 3px; color: #fff; font-weight: 700; }

    /* â”€â”€ MAIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .adm-main { flex: 1; overflow-y: auto; padding: 24px; }
    .empty-hint { text-align: center; padding: 80px 20px; color: var(--color-text-light); }
    .empty-hint h3 { margin-bottom: 8px; font-size: 1rem; }

    /* â”€â”€ EDITOR CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .editor-card { background: #fff; border: 1px solid var(--color-border); border-radius: 8px; padding: 24px; max-width: 800px; }
    .editor-card > h2 { font-size: 0.93rem; margin: 0 0 18px; padding-bottom: 12px; border-bottom: 1px solid var(--color-border); }

    .form-row3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 14px; margin-bottom: 14px; }
    .form-row2 { display: grid; grid-template-columns: 1fr 2fr; gap: 14px; margin-bottom: 14px; }
    .fgroup    { display: flex; flex-direction: column; gap: 5px; }
    .fgroup label { font-size: 0.74rem; font-weight: 700; color: var(--color-text-light); letter-spacing: 0.05em; text-transform: uppercase; }
    .fgroup input[type="text"],
    .fgroup select {
      padding: 8px 10px;
      border: 1px solid var(--color-border);
      border-radius: 4px;
      font-size: 0.87rem;
      font-family: inherit;
      transition: border-color 0.15s;
    }
    .fgroup input:focus, .fgroup select:focus {
      outline: none;
      border-color: var(--color-secondary);
      box-shadow: 0 0 0 2px rgba(74,143,212,0.12);
    }

    /* â”€â”€ STOPS TABLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .stops-head { display: flex; align-items: center; justify-content: space-between; margin: 22px 0 10px; }
    .stops-head h3 { font-size: 0.87rem; margin: 0; }
    .stops-head small { font-size: 0.72rem; color: var(--color-text-light); }

    table.stbl { width: 100%; border-collapse: collapse; font-size: 0.82rem; }
    .stbl th {
      padding: 7px 10px;
      background: var(--color-bg);
      border: 1px solid var(--color-border);
      font-size: 0.73rem;
      font-weight: 700;
      color: var(--color-text-light);
      text-align: left;
    }
    .stbl td { padding: 5px 7px; border: 1px solid var(--color-border); vertical-align: middle; }
    .stbl select,
    .stbl input[type="time"] {
      width: 100%;
      padding: 5px 6px;
      border: 1px solid var(--color-border);
      border-radius: 3px;
      font-size: 0.81rem;
      font-family: inherit;
      background: #fff;
    }
    .stbl input[type="time"]:disabled { background: #f0f0f0; color: #ccc; border-color: #e4e4e4; }
    .stbl .ico { background: none; border: none; cursor: pointer; padding: 3px 5px; font-size: 0.88rem; color: #bbb; border-radius: 3px; }
    .stbl .ico:hover:not(:disabled) { background: var(--color-bg); color: var(--color-primary); }
    .stbl .ico:disabled { opacity: 0.25; cursor: default; }
    .stbl .ico.del:hover:not(:disabled) { color: #d03030; background: #fff0f0; }

    .btn-add-stop {
      margin-top: 8px; width: 100%; padding: 7px;
      background: none; border: 1.5px dashed var(--color-border);
      border-radius: 4px; cursor: pointer; font-size: 0.81rem;
      color: var(--color-text-light); font-family: inherit;
    }
    .btn-add-stop:hover { border-color: var(--color-secondary); color: var(--color-secondary); }

    /* â”€â”€ EDITOR ACTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .editor-actions {
      margin-top: 22px; padding-top: 14px; border-top: 1px solid var(--color-border);
      display: flex; justify-content: flex-end;
    }
    .btn-del {
      padding: 7px 16px; background: none; border: 1px solid #d03030;
      color: #d03030; border-radius: 4px; cursor: pointer; font-size: 0.81rem; font-family: inherit;
    }
    .btn-del:hover { background: #fff0f0; }

    /* â”€â”€ EXPORT BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .adm-export {
      flex-shrink: 0; background: #fff; border-top: 1px solid var(--color-border);
      padding: 9px 18px; display: flex; align-items: center; gap: 9px;
    }
    .adm-export .count { font-size: 0.8rem; color: var(--color-text-light); }

    /* â”€â”€ MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .modal-overlay {
      display: none; position: fixed; inset: 0;
      background: rgba(0,0,0,0.42); z-index: 500;
      align-items: center; justify-content: center;
    }
    .modal-overlay.open { display: flex; }
    .modal-box {
      background: #fff; border-radius: 8px; padding: 24px;
      width: 90%; max-width: 520px; box-shadow: 0 8px 32px rgba(0,0,0,0.2);
    }
    .modal-box h3 { margin: 0 0 10px; font-size: 0.93rem; }
    .modal-box p  { font-size: 0.8rem; color: #777; margin: 0 0 10px; }
    .modal-box textarea {
      width: 100%; height: 180px; border: 1px solid var(--color-border);
      border-radius: 4px; padding: 8px; font-size: 0.78rem; font-family: monospace; resize: vertical;
    }
    .modal-actions { display: flex; gap: 8px; margin-top: 12px; justify-content: flex-end; }

    /* â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .toast {
      position: fixed; bottom: 20px; right: 20px;
      background: var(--color-primary); color: #fff;
      padding: 9px 18px; border-radius: 6px; font-size: 0.8rem;
      display: none; z-index: 9999; box-shadow: 0 4px 14px rgba(0,0,0,0.22);
    }

    /* â”€â”€ DATE CHIPS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .date-chip { display: inline-flex; align-items: center; gap: 3px; background: #e8eef8; border-radius: 3px; padding: 3px 8px; font-size: 0.77rem; }
    .date-chip-del { background: none; border: none; cursor: pointer; color: #aaa; padding: 0 2px; line-height: 1; }
    .date-chip-del:hover { color: #d03030; }

    /* â”€â”€ TEXTAREA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .fgroup textarea {
      padding: 8px 10px; border: 1px solid var(--color-border); border-radius: 4px;
      font-size: 0.87rem; font-family: inherit; transition: border-color 0.15s;
    }
    .fgroup textarea:focus { outline: none; border-color: var(--color-secondary); box-shadow: 0 0 0 2px rgba(74,143,212,0.12); }

    /* â”€â”€ CAR CONFIG TABLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .cars-head { display:flex; align-items:center; justify-content:space-between; margin:22px 0 8px; flex-wrap:wrap; gap:8px; }
    .cars-head h3 { font-size:0.87rem; margin:0; }
    .template-bar { display:flex; align-items:center; gap:6px; flex-wrap:wrap; padding:8px 10px; background:var(--color-bg); border-radius:4px; margin-bottom:8px; }
    .template-bar > span { font-size:0.74rem; font-weight:700; color:var(--color-text-light); white-space:nowrap; }
    .template-bar select { padding:4px 7px; border:1px solid var(--color-border); border-radius:3px; font-size:0.79rem; font-family:inherit; flex:1; min-width:100px; }
    table.cartbl { width:100%; border-collapse:collapse; font-size:0.82rem; }
    .cartbl th { padding:7px 10px; background:var(--color-bg); border:1px solid var(--color-border); font-size:0.73rem; font-weight:700; color:var(--color-text-light); text-align:left; }
    .cartbl td { padding:5px 7px; border:1px solid var(--color-border); vertical-align:middle; }
    .cartbl input, .cartbl select { width:100%; padding:5px 6px; border:1px solid var(--color-border); border-radius:3px; font-size:0.81rem; font-family:inherit; background:#fff; }
    .btn-add-car { margin-top:8px; width:100%; padding:7px; background:none; border:1.5px dashed var(--color-border); border-radius:4px; cursor:pointer; font-size:0.81rem; color:var(--color-text-light); font-family:inherit; }
    .btn-add-car:hover { border-color:var(--color-secondary); color:var(--color-secondary); }

    /* â”€â”€ ADMIN TAB SWITCHER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .adm-tabs { display:flex; background:#fff; border-bottom:2px solid var(--color-border); flex-shrink:0; }
    .adm-tab { padding:8px 22px; border:none; border-bottom:2px solid transparent; background:none; cursor:pointer; font-size:0.82rem; font-family:inherit; color:var(--color-text-light); letter-spacing:0.05em; transition:color 0.15s; margin-bottom:-2px; }
    .adm-tab.active { color:var(--color-primary); border-bottom-color:var(--color-primary); font-weight:700; }
    .adm-tab:hover:not(.active) { color:var(--color-primary); }

    /* â”€â”€ RESERVATION VIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .adm-resv-view { display:none; flex:1; overflow-y:auto; padding:20px 24px; flex-direction:column; }
    .adm-resv-view.show { display:flex; }
    .resv-toolbar { display:flex; align-items:center; gap:10px; margin-bottom:16px; flex-wrap:wrap; }
    .resv-toolbar h2 { font-size:0.95rem; margin:0; }
    .resv-toolbar input { padding:5px 10px; border:1px solid var(--color-border); border-radius:4px; font-size:0.82rem; font-family:inherit; min-width:180px; }
    table.resv-table { width:100%; border-collapse:collapse; font-size:0.8rem; background:#fff; }
    .resv-table th { padding:8px 10px; background:var(--color-bg); border:1px solid var(--color-border); font-size:0.71rem; font-weight:700; color:var(--color-text-light); text-align:left; white-space:nowrap; }
    .resv-table td { padding:7px 10px; border:1px solid var(--color-border); vertical-align:middle; }
    .resv-table tbody tr:hover td { background:#f4f8ff; }

    /* â”€â”€ GITHUB PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .gh-panel { display:none; background:#f8f9fc; border-top:1px solid var(--color-border); padding:10px 18px; }
    .gh-panel.open { display:block; }
    .gh-panel h4 { font-size:0.8rem; margin:0 0 8px; color:var(--color-primary); }
    .gh-form { display:flex; gap:8px; flex-wrap:wrap; align-items:flex-end; }
    .gh-sync-mode { display:flex; gap:14px; align-items:center; margin-top:8px; font-size:0.78rem; }
    .gh-sync-mode label { display:flex; align-items:center; gap:4px; cursor:pointer; }
    .gh-form .fgroup { flex:1; min-width:120px; }
    .gh-form .fgroup label { font-size:0.72rem; }
    .gh-form .fgroup input { padding:6px 8px; font-size:0.82rem; }
    .gh-sync-btn { padding:7px 16px; font-size:0.8rem; white-space:nowrap; }
    .gh-sync-btn.syncing { opacity:0.6; pointer-events:none; }

    @media (max-width: 700px) {
      .adm-sidebar { display: none; }
      .form-row3 { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

  <!-- HEADER -->
  <div class="adm-header">
    <div>
      <div class="adm-header-sub">äº¬è¯é¢¨ã®èŠ½ æ—…å®¢é‹è¼¸éƒ¨é–€</div>
      <div class="adm-header-title">eã‚‹ã‚Šãã‚…ã† æ™‚åˆ»è¡¨ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </div>
    </div>
    <div class="adm-header-right">
      <span class="save-status" id="save-status">â€”</span>
      <a href="reservation.html" style="color:#9dc0f0; font-size:0.76rem; text-decoration:none;">â† äºˆç´„ãƒšãƒ¼ã‚¸ã¸</a>
    </div>
  </div>

  <!-- TAB SWITCHER -->
  <div class="adm-tabs">
    <button class="adm-tab active" id="tab-timetable" onclick="switchAdmTab('timetable')">ğŸš† æ™‚åˆ»è¡¨ç®¡ç†</button>
    <button class="adm-tab" id="tab-reservations" onclick="switchAdmTab('reservations')">ğŸ“‹ äºˆç´„ä¸€è¦§</button>
  </div>

  <!-- BODY -->
  <div class="adm-body" id="adm-body">

    <!-- SIDEBAR -->
    <aside class="adm-sidebar">
      <div class="sidebar-top">
        <h2>åˆ—è»Šä¸€è¦§</h2>
        <button class="btn btn-primary" style="padding:4px 10px; font-size:0.76rem;" onclick="newTrain()">ï¼‹ æ–°è¦</button>
      </div>
      <div class="sidebar-list" id="train-list"></div>
    </aside>

    <!-- MAIN EDITOR -->
    <main class="adm-main" id="adm-main">
      <div class="empty-hint" id="empty-hint">
        <h3>åˆ—è»Šã‚’é¸æŠã—ã¦ãã ã•ã„</h3>
        <p>å·¦ã®ãƒªã‚¹ãƒˆã‹ã‚‰é¸ã¶ã‹ã€ã€Œï¼‹ æ–°è¦ã€ã§è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</p>
      </div>
    </main>

  </div>

  <!-- GITHUB SETTINGS PANEL -->
  <div class="gh-panel" id="gh-panel">
    <h4>âš™ GitHub åŒæœŸè¨­å®š</h4>
    <div class="gh-form">
      <div class="fgroup">
        <label>ã‚ªãƒ¼ãƒŠãƒ¼å</label>
        <input type="text" id="gh-owner" placeholder="ä¾‹: RateCal" oninput="saveGhConfig()">
      </div>
      <div class="fgroup">
        <label>ãƒªãƒã‚¸ãƒˆãƒªå</label>
        <input type="text" id="gh-repo" placeholder="ä¾‹: kznm-website" oninput="saveGhConfig()">
      </div>
      <div class="fgroup" style="flex:0.5; min-width:72px;">
        <label>ãƒ–ãƒ©ãƒ³ãƒ</label>
        <input type="text" id="gh-branch" placeholder="main" oninput="saveGhConfig()">
      </div>
      <div class="fgroup" style="flex:2;">
        <label>Personal Access Token (repo ã‚¹ã‚³ãƒ¼ãƒ—å¿…è¦)</label>
        <input type="password" id="gh-pat" placeholder="ghp_xxxxxxxxxxxx" oninput="saveGhConfig()">
      </div>
    </div>
    <p style="font-size:0.72rem; color:#aaa; margin:6px 0 0;">PAT ã¯ localStorage ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚å…¬å…±ç«¯æœ«ã§ã®ä½¿ç”¨ã¯é¿ã‘ã¦ãã ã•ã„ã€‚</p>
    <div class="gh-sync-mode">
      <span style="color:var(--color-text-light);">è‡ªå‹•åŒæœŸï¼š</span>
      <label><input type="radio" name="gh-autosync" value="always" onchange="saveGhConfig()"> å¸¸æ™‚ï¼ˆå¤‰æ›´æ™‚ã«è‡ªå‹•ï¼‰</label>
      <label><input type="radio" name="gh-autosync" value="off" checked onchange="saveGhConfig()"> åœæ­¢</label>
    </div>
  </div>

  <!-- EXPORT BAR -->
  <div class="adm-export" id="adm-export">
    <span class="count" id="train-count">ç™»éŒ²: 0æœ¬</span>
    <button class="btn btn-outline" style="padding:6px 13px; font-size:0.8rem;" onclick="openImport()">ğŸ“‚ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
    <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
      <button class="btn btn-outline" style="padding:6px 13px; font-size:0.8rem;" onclick="copyCode()">ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼</button>
      <button class="btn btn-primary" style="padding:6px 16px; font-size:0.8rem;" onclick="exportFile()">ğŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
      <button class="btn btn-primary gh-sync-btn" id="gh-sync-btn" onclick="syncToGitHub()" style="background:#2ea44f; border-color:#2ea44f;">ğŸ”„ GitHub ã«åŒæœŸ</button>
      <button class="btn btn-outline" style="padding:6px 9px; font-size:0.8rem;" onclick="toggleGhPanel()" title="GitHubè¨­å®š">âš™</button>
    </div>
  </div>

  <!-- IMPORT MODAL -->
  <div class="modal-overlay" id="import-modal">
    <div class="modal-box">
      <h3>ğŸ“‚ ãƒ‡ãƒ¼ã‚¿ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h3>
      <p>ä»¥å‰ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ãŸ <code>timetable-data.js</code> ã®å†…å®¹ã‚’ãã®ã¾ã¾è²¼ã‚Šä»˜ã‘ã‚‹ã‹ã€<br>JSON å½¢å¼ï¼ˆ<code>{"trains":[...]}</code>ï¼‰ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
      <textarea id="import-ta" placeholder='const TIMETABLE = { "trains": [...] };'></textarea>
      <div class="modal-actions">
        <button class="btn btn-outline" style="padding:7px 14px; font-size:0.81rem;" onclick="closeImport()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn btn-primary" style="padding:7px 14px; font-size:0.81rem;" onclick="doImport()">ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹</button>
      </div>
    </div>
  </div>

  <!-- RESERVATION VIEW -->
  <div class="adm-resv-view" id="adm-resv-view">
    <div class="resv-toolbar">
      <div style="flex:1;">
        <h2>äºˆç´„ä¸€è¦§</h2>
        <p id="resv-count" style="font-size:0.77rem; color:var(--color-text-light); margin:3px 0 0;"></p>
      </div>
      <input type="text" id="resv-filter" placeholder="MCIDã§çµã‚Šè¾¼ã¿â€¦" oninput="renderReservations()">
      <button class="btn btn-outline" style="padding:5px 12px; font-size:0.8rem;" onclick="_fetchReservationsFromGitHub().then(()=>renderReservations())">â†» GitHub ã‹ã‚‰æ›´æ–°</button>
      <button class="btn btn-outline" style="padding:5px 12px; font-size:0.8rem; color:#d03030; border-color:#d03030;" onclick="clearAllReservations()">å…¨ä»¶å‰Šé™¤</button>
    </div>
    <div id="resv-list" style="overflow-x:auto;"></div>
  </div>

  <div class="toast" id="toast"></div>

<script>
// =============================================================================
// é§…ãƒ‡ãƒ¼ã‚¿ï¼ˆreservation.js ã® STATION_REGISTRY ã¨åŒä¸€å†…å®¹ã‚’ä¿ã¤ã“ã¨ï¼‰
// =============================================================================
const STATION_REGISTRY = {
  'A1': { name: 'ç‘ ç’ƒæ¾å³¶',     numbered: true  },
  'A2': { name: 'ä¸‹æ¾å¸‚',       numbered: true  },
  'A3': { name: 'æ°·åŸ',         numbered: true  },
  'A4': { name: 'é’ä¹ƒé¹¿',       numbered: true  },
  'A5': { name: 'æ–°é›ªè¦‹é‡',     numbered: true  },
  'A6': { name: 'è½åˆã‚‚ã¿ã˜å£', numbered: true  },
  'A7': { name: 'ç´¡ä¹ƒå¸‚',       numbered: true  },
  'A8': { name: 'æ–°ç´¡ä¹ƒ',       numbered: true  },
  'B1': { name: 'æ±ç˜å°',       numbered: true  },
  'B2': { name: 'çŸ³å¡šå¤§æ³‰',     numbered: true  },
  'B3': { name: 'è¥¿éƒ½',         numbered: true  },
  'B4': { name: 'æ–°ã€…éƒ½å¿ƒ',     numbered: true  },
  'C1': { name: 'å¸¯ã®èŠ±',       numbered: true  },
  'C2': { name: 'è½åˆæ–°èŠ±å³¶',   numbered: true  },
  'Y01': { name: 'å·è¶Š',        numbered: false },
  'Y02': { name: 'æ¥“é«˜é‡å°',    numbered: false },
  'X01': { name: 'æ–°æ¸‹è°·',      numbered: false },
};

// =============================================================================
// ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸
// =============================================================================
const STORAGE_KEY = 'kznm-timetable-v1';

function loadState() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (raw) return JSON.parse(raw);
  } catch { /* ignore */ }
  return { trains: [] };
}

function saveState() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  const t = new Date();
  document.getElementById('save-status').textContent =
    `ä¿å­˜æ¸ˆã¿ ${t.getHours()}:${String(t.getMinutes()).padStart(2,'0')}`;
  _scheduleAutoSync();
}

let state = loadState();
let currentId = null;

// =============================================================================
// ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
// =============================================================================
function switchAdmTab(tab) {
  document.querySelectorAll('.adm-tab').forEach(t => t.classList.remove('active'));
  document.getElementById('tab-' + tab).classList.add('active');

  const isTimetable = tab === 'timetable';
  document.getElementById('adm-body').style.display     = isTimetable ? 'flex' : 'none';
  document.getElementById('gh-panel').style.display     = isTimetable ? '' : 'none !important'; // let .open class control when timetable
  document.getElementById('adm-export').style.display   = isTimetable ? '' : 'none';
  document.getElementById('adm-resv-view').style.display = isTimetable ? 'none' : 'flex';
  if (!isTimetable) {
    // gh-panel ã‚’å¼·åˆ¶éè¡¨ç¤ºï¼ˆinline styleã§ä¸Šæ›¸ãï¼‰
    document.getElementById('gh-panel').style.display = 'none';
    _fetchReservationsFromGitHub().then(() => renderReservations());
  } else {
    document.getElementById('gh-panel').style.display = '';
  }
}

// =============================================================================
// äºˆç´„ä¸€è¦§
// =============================================================================
const RESV_KEY = 'kznm-reservations-v1';

// GitHub ã‹ã‚‰ data/reservations.json ã‚’å–å¾—ã—ã¦ localStorage ã«åæ˜ 
async function _fetchReservationsFromGitHub() {
  const owner = localStorage.getItem('gh-owner') || '';
  const repo  = localStorage.getItem('gh-repo')  || '';
  const pat   = localStorage.getItem('gh-pat')   || '';
  if (!owner || !repo || !pat) return;
  try {
    const headers = { 'Authorization': `token ${pat}`, 'Accept': 'application/vnd.github.v3+json' };
    const res = await fetch(
      `https://api.github.com/repos/${owner}/${repo}/contents/data/reservations.json`, { headers });
    if (!res.ok) return;
    const data = await res.json();
    // GitHub API ã¯ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ base64 ã§è¿”ã™
    const json = decodeURIComponent(
      atob(data.content.replace(/\n/g, ''))
        .split('').map(c => '%' + c.charCodeAt(0).toString(16).padStart(2,'0')).join('')
    );
    localStorage.setItem(RESV_KEY, json);
  } catch { /* å–å¾—å¤±æ•—ã¯ç„¡è¦– */ }
}

function getReservations() {
  try {
    const raw = localStorage.getItem(RESV_KEY);
    return raw ? (JSON.parse(raw).reservations || []) : [];
  } catch { return []; }
}

function _extractTypeFromLabel(typeLabel) {
  const lbl = typeLabel || '';
  if (lbl.includes('ç‰¹æ€¥'))         return 'express';
  if (lbl.includes('ç‰¹åˆ¥å¿«é€Ÿ'))     return 'special-rapid';
  if (lbl.includes('ï¾ï¾˜ï¾ƒï¾ï½°') || lbl.includes('ãƒ›ãƒªãƒ‡ãƒ¼')) return 'holiday-rapid';
  if (lbl.includes('å›£ä½“'))         return 'charter';
  return 'rapid';
}

function renderReservations() {
  const filter = (document.getElementById('resv-filter')?.value || '').toLowerCase();
  const all    = getReservations();
  const list   = filter ? all.filter(r => (r.mcid||'').toLowerCase().includes(filter) || (r.id||'').toLowerCase().includes(filter)) : all;

  const countEl = document.getElementById('resv-count');
  if (countEl) countEl.textContent = `${list.length}ä»¶${filter ? 'ï¼ˆçµã‚Šè¾¼ã¿ä¸­ï¼‰' : ''}ã€€è¨ˆ ${all.length} ä»¶`;

  const container = document.getElementById('resv-list');
  if (!container) return;

  if (!list.length) {
    container.innerHTML = `<div style="text-align:center;padding:60px 20px;color:#bbb;">
      <p style="font-size:1.5rem;margin-bottom:8px;">ğŸ“­</p>
      <p style="font-size:0.85rem;">${all.length > 0 ? 'çµã‚Šè¾¼ã¿çµæœãŒã‚ã‚Šã¾ã›ã‚“' : 'äºˆç´„ãƒ‡ãƒ¼ã‚¿ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“'}</p>
    </div>`;
    return;
  }

  container.innerHTML = `<table class="resv-table">
    <thead><tr>
      <th>ç™ºè¡Œæ—¥æ™‚</th>
      <th>åˆ‡ç¬¦ No.</th>
      <th>Minecraft ID</th>
      <th>ä¹—è»Šæ—¥</th>
      <th>åˆ—è»Š</th>
      <th>åŒºé–“</th>
      <th>æ™‚åˆ»</th>
      <th>åº§å¸­</th>
      <th>äººæ•°</th>
      <th style="text-align:right;">é‹è³ƒ</th>
      <th></th>
    </tr></thead>
    <tbody>
      ${list.map(r => {
        const typeColor = adminTypeInfo(_extractTypeFromLabel(r.typeLabel)).color;
        const issued = new Date(r.issuedAt).toLocaleString('ja-JP',{hour12:false}).slice(0,16);
        return `<tr>
          <td style="white-space:nowrap;font-size:0.74rem;color:#aaa;">${esc(issued)}</td>
          <td style="font-family:monospace;font-size:0.73rem;color:#999;">${esc(r.id)}</td>
          <td style="font-weight:700;">${esc(r.mcid)}</td>
          <td style="white-space:nowrap;">${esc(r.date)}</td>
          <td style="white-space:nowrap;">
            <span style="font-size:0.68rem;color:#fff;background:${typeColor};padding:1px 6px;border-radius:2px;">${esc(r.typeLabel)}</span>
            ${r.trainNo ? `<span style="font-size:0.74rem;color:#aaa;"> ${esc(r.trainNo)}å·</span>` : ''}
            ${r.trainName ? `<br><span style="font-size:0.77rem;">${esc(r.trainName)}</span>` : ''}
          </td>
          <td style="white-space:nowrap;">${esc(r.fromName)}&nbsp;â†’&nbsp;${esc(r.toName)}</td>
          <td style="font-family:monospace;font-size:0.86rem;white-space:nowrap;">${esc(r.depTime)}&nbsp;â†’&nbsp;${esc(r.arrTime)}</td>
          <td style="font-size:0.78rem;">${esc(r.seat || r.seatLabel || 'â€”')}</td>
          <td style="text-align:center;">${r.pax}å</td>
          <td style="text-align:right;font-weight:700;">Â¥${(r.fare||0).toLocaleString()}</td>
          <td><button class="ico del" onclick="deleteReservation('${esc(r.id)}')" title="å‰Šé™¤">âœ•</button></td>
        </tr>`;
      }).join('')}
    </tbody>
  </table>`;
}

function deleteReservation(id) {
  try {
    const raw = localStorage.getItem(RESV_KEY);
    if (!raw) return;
    const store = JSON.parse(raw);
    store.reservations = store.reservations.filter(r => r.id !== id);
    localStorage.setItem(RESV_KEY, JSON.stringify(store));
    renderReservations();
    showToast('äºˆç´„ã‚’1ä»¶å‰Šé™¤ã—ã¾ã—ãŸ');
  } catch { }
}

function clearAllReservations() {
  const all = getReservations();
  if (!all.length) { showToast('äºˆç´„ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
  if (!confirm(`å…¨ ${all.length} ä»¶ã®äºˆç´„ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) return;
  localStorage.removeItem(RESV_KEY);
  renderReservations();
  showToast('å…¨ä»¶å‰Šé™¤ã—ã¾ã—ãŸ');
}

// =============================================================================
// ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼šåˆ—è»Šä¸€è¦§
// =============================================================================
function renderSidebar() { renderList(); }

function renderList() {
  const el = document.getElementById('train-list');
  document.getElementById('train-count').textContent = `ç™»éŒ²: ${state.trains.length}æœ¬`;

  if (state.trains.length === 0) {
    el.innerHTML = '<p style="padding:14px;font-size:0.78rem;color:#bbb;">åˆ—è»ŠãŒã‚ã‚Šã¾ã›ã‚“</p>';
    return;
  }

  el.innerHTML = state.trains.map(t => {
    const first = t.stops[0];
    const last  = t.stops[t.stops.length - 1];
    const time  = (first && first.dep)
      ? first.dep + (last && last.arr ? ' â†’ ' + last.arr : '')
      : 'æ™‚åˆ»æœªè¨­å®š';
    return `
      <div class="train-item${t.id === currentId ? ' active' : ''}" onclick="selectTrain('${t.id}')">
        <div class="train-item-name">
          <span class="type-pill" style="background:${adminTypeInfo(t.type).color};">${adminTypeInfo(t.type).label}</span>
          ${t.trainNo ? `<span style="font-size:0.7rem;color:#999;">${esc(t.trainNo)}</span>` : ''}
          ${esc(t.name || 'ï¼ˆåç§°æœªè¨­å®šï¼‰')}
        </div>
        <div class="train-item-meta">
          ${t.reserveOpen ? '<span style="color:#1a7a3a;font-weight:700;">â— äºˆç´„å—ä»˜ä¸­</span>&emsp;' : '<span style="color:#aaa;">â—‹ å—ä»˜åœæ­¢</span>&emsp;'}${dayLabel(t.runDays)}&emsp;${t.stops.length}é§…&emsp;${time}
        </div>
      </div>`;
  }).join('');
}

// =============================================================================
// åˆ—è»Šã®é¸æŠ / æ–°è¦ / å‰Šé™¤
// =============================================================================
function selectTrain(id) {
  currentId = id;
  renderList();
  renderEditor();
}

function newTrain() {
  const id = 'train-' + Date.now();
  state.trains.push({ id, type: 'rapid', trainNo: '', name: '', runDays: 'daily', notice: '', charterPass: '', reserveOpen: false, cars: [], stops: [] });
  saveState();
  selectTrain(id);
}

function deleteTrain() {
  if (!currentId) return;
  const t = state.trains.find(x => x.id === currentId);
  const label = t ? (t.name || 'åç§°æœªè¨­å®š') : '';
  if (!confirm(`ã€Œ${label}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
  state.trains = state.trains.filter(x => x.id !== currentId);
  currentId = null;
  saveState();
  renderList();
  document.getElementById('adm-main').innerHTML =
    '<div class="empty-hint"><h3>å‰Šé™¤ã—ã¾ã—ãŸ</h3></div>';
}

function currentTrain() {
  return state.trains.find(t => t.id === currentId) || null;
}

// =============================================================================
// ã‚¨ãƒ‡ã‚£ã‚¿æç”»
// =============================================================================
function renderEditor() {
  const t = currentTrain();
  if (!t) return;

  const isSpecific  = Array.isArray(t.runDays);
  const recurVal    = isSpecific ? 'specific' : (t.runDays || 'daily');
  const dateChipsHtml = isSpecific
    ? t.runDays.map(d => `<span class="date-chip">${esc(d)}<button class="date-chip-del" onclick="removeDate('${esc(d)}')">âœ•</button></span>`).join('')
    : '';

  document.getElementById('adm-main').innerHTML = `
    <div class="editor-card">
      <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:18px; padding-bottom:14px; border-bottom:1px solid var(--color-border);">
        <h2 style="margin:0; font-size:0.93rem;">åˆ—è»Šæƒ…å ±ã®ç·¨é›†</h2>
        <div style="display:flex; align-items:center; gap:10px;">
          <button id="train-sync-btn" class="btn btn-outline" style="font-size:0.78rem; padding:5px 13px; background:#2ea44f; border-color:#2ea44f; color:#fff;" onclick="syncThisTrain(this)">ğŸ”„ æ™‚åˆ»è¡¨ã‚’åŒæœŸ</button>
          <span id="reserve-status-badge" style="font-size:0.78rem; font-weight:700; letter-spacing:0.06em; padding:4px 12px; border-radius:20px; ${t.reserveOpen ? 'background:#d4f0dc; color:#1a7a3a;' : 'background:#f0f0f0; color:#999;'}">
            ${t.reserveOpen ? 'â— äºˆç´„å—ä»˜ä¸­' : 'â—‹ å—ä»˜åœæ­¢ä¸­'}
          </span>
          <button id="reserve-toggle-btn" class="btn" style="font-size:0.8rem; padding:5px 16px; ${t.reserveOpen ? 'background:#c0392b; border-color:#c0392b; color:#fff;' : 'background:#1a7a3a; border-color:#1a7a3a; color:#fff;'}" onclick="toggleReserveOpen()">
            ${t.reserveOpen ? 'äºˆç´„ã‚’ã€†åˆ‡ã‚‹' : 'äºˆç´„ã‚’è§£æ”¾ã™ã‚‹'}
          </button>
        </div>
      </div>

      <div class="form-row3">
        <div class="fgroup">
          <label>ç¨®åˆ¥</label>
          <select id="f-type" onchange="setField('type', this.value); toggleCharterPass(this.value);">
            <option value="rapid"          ${t.type==='rapid'          ? 'selected' : ''}>æ€¥è¡Œ</option>
            <option value="express"        ${t.type==='express'        ? 'selected' : ''}>ç‰¹æ€¥</option>
            <option value="special-rapid"  ${t.type==='special-rapid'  ? 'selected' : ''}>ç‰¹åˆ¥å¿«é€Ÿ</option>
            <option value="holiday-rapid"  ${t.type==='holiday-rapid'  ? 'selected' : ''}>ãƒ›ãƒªãƒ‡ãƒ¼å¿«é€Ÿ</option>
            <option value="charter"        ${t.type==='charter'        ? 'selected' : ''}>è‡¨æ™‚ï¼ˆå›£ä½“ï¼‰</option>
          </select>
        </div>
        <div class="fgroup">
          <label>åˆ—è»Šç•ªå·</label>
          <input type="text" id="f-trainno" value="${esc(t.trainNo||'')}" placeholder="ä¾‹: 1001"
            oninput="setField('trainNo', this.value)">
        </div>
        <div class="fgroup">
          <label>åˆ—è»Šå</label>
          <input type="text" id="f-name" value="${esc(t.name)}" placeholder="ä¾‹: æ€¥è¡Œ ç´¡ä¹ƒ1å·"
            oninput="setField('name', this.value)">
        </div>
      </div>

      <div class="form-row2" id="charter-pass-row" style="align-items:flex-start; margin-bottom:14px; display:${t.type==='charter' ? 'grid' : 'none'};">
        <div class="fgroup">
          <label>äºˆç´„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆå›£ä½“å°‚ç”¨ï¼‰</label>
          <input type="text" id="f-charter-pass" value="${esc(t.charterPass||'')}" placeholder="ä¹—å®¢ã«é€šçŸ¥ã™ã‚‹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®š"
            oninput="setField('charterPass', this.value)" autocomplete="off">
        </div>
        <div class="fgroup" style="display:flex; align-items:flex-end; padding-bottom:2px;">
          <p style="font-size:0.76rem; color:var(--color-text-light); line-height:1.7; margin:0;">
            è¨­å®šã—ãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’æ­£ã—ãå…¥åŠ›ã—ãŸä¹—å®¢ã®ã¿äºˆç´„ã§ãã¾ã™ã€‚<br>
            ç©ºæ¬„ã®å ´åˆã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãªã—ã§äºˆç´„å¯èƒ½ã§ã™ã€‚
          </p>
        </div>
      </div>

      <div class="form-row3" id="charter-supplement-row" style="margin-bottom:14px; display:${t.type==='charter' ? 'grid' : 'none'};">
        <div class="fgroup">
          <label>æ–™é‡‘ãƒ»åŸºæœ¬é¡ (Â¥)</label>
          <input type="number" id="f-suppl-base" value="${t.supplement?.base ?? 800}" min="0" step="50"
            oninput="setNestedField('supplement','base', parseInt(this.value)||0)">
        </div>
        <div class="fgroup">
          <label>æ–™é‡‘ãƒ»å‰²å¼•é¡ (Â¥)</label>
          <input type="number" id="f-suppl-discount" value="${t.supplement?.discount ?? 600}" min="0" step="50"
            oninput="setNestedField('supplement','discount', parseInt(this.value)||0)">
        </div>
        <div class="fgroup" style="display:flex; align-items:flex-end; padding-bottom:2px;">
          <p style="font-size:0.76rem; color:var(--color-text-light); line-height:1.7; margin:0;">
            ç‰¹æ€¥åˆ¸ã®ã¿è³¼å…¥æ™‚ã¯å‰²å¼•é¡ã€ä¹—è»Šåˆ¸ã‚»ãƒƒãƒˆã¯åŸºæœ¬é¡ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
          </p>
        </div>
      </div>

      <div class="form-row2" style="align-items:flex-start; margin-bottom:14px;">
        <div class="fgroup">
          <label>é‹è»¢æ—¥</label>
          <select id="f-days-type" onchange="onRunDaysTypeChange(this.value)">
            <option value="daily"    ${recurVal==='daily'    ? 'selected' : ''}>æ¯æ—¥</option>
            <option value="weekday"  ${recurVal==='weekday'  ? 'selected' : ''}>å¹³æ—¥ã®ã¿</option>
            <option value="weekend"  ${recurVal==='weekend'  ? 'selected' : ''}>ä¼‘æ—¥ã®ã¿</option>
            <option value="specific" ${recurVal==='specific' ? 'selected' : ''}>æŒ‡å®šæ—¥</option>
          </select>
        </div>
        <div class="fgroup" id="f-specific-wrap" style="display:${isSpecific?'flex':'none'}; flex-direction:column; gap:6px;">
          <label>&nbsp;</label>
          <div style="display:flex; gap:6px;">
            <input type="date" id="f-date-add">
            <button class="btn btn-outline" style="padding:5px 10px; font-size:0.79rem; white-space:nowrap;" onclick="addDate()">ï¼‹ è¿½åŠ </button>
          </div>
          <div id="f-date-chips" style="display:flex; flex-wrap:wrap; gap:4px; margin-top:2px;">
            ${dateChipsHtml}
          </div>
        </div>
      </div>

      <div class="fgroup" style="margin-bottom:20px;">
        <label>ä¹—å®¢ã¸ã®æ³¨æ„äº‹é …ï¼ˆä»»æ„ï¼‰</label>
        <textarea id="f-notice" rows="3" placeholder="ä¾‹: æ··é›‘æ™‚ã¯è‡ªç”±å¸­ã‚’ãŠæ–­ã‚Šã™ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚"
          oninput="setField('notice', this.value)">${esc(t.notice||'')}</textarea>
      </div>

      <div class="stops-head">
        <h3>åœè»Šé§…ãƒ»æ™‚åˆ»</h3>
        <small>å§‹ç™ºã¯ã€Œç€ã€ãªã—ã€çµ‚ç€ã¯ã€Œç™ºã€ãªã—</small>
      </div>

      <table class="stbl">
        <thead>
          <tr>
            <th style="width:32px;">#</th>
            <th>é§…</th>
            <th style="width:120px;">ç€ æ™‚åˆ»</th>
            <th style="width:120px;">ç™º æ™‚åˆ»</th>
            <th style="width:88px;"></th>
          </tr>
        </thead>
        <tbody>${renderStops(t.stops)}</tbody>
      </table>
      <button class="btn-add-stop" onclick="addStop()">ï¼‹ åœè»Šé§…ã‚’è¿½åŠ </button>

      <div class="cars-head">
        <h3>ç·¨æˆãƒ»åº§å¸­è¨­å®š</h3>
        <small style="color:var(--color-text-light);">å·è»Šãƒ»åº§å¸­ã‚¯ãƒ©ã‚¹ãƒ»å®šå“¡</small>
      </div>
      <div class="template-bar">
        <span>ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</span>
        <select id="f-tmpl">
          <option value="">â€” é¸æŠ â€”</option>
          ${getTemplates().map(tp => `<option value="${esc(tp.name)}">${esc(tp.name)}</option>`).join('')}
        </select>
        <button class="btn btn-outline" style="padding:4px 10px;font-size:0.77rem;white-space:nowrap;" onclick="loadTemplate()">èª­ã¿è¾¼ã‚€</button>
        <button class="btn btn-outline" style="padding:4px 10px;font-size:0.77rem;white-space:nowrap;" onclick="saveTemplate()">ã“ã®ç·¨æˆã‚’ä¿å­˜</button>
        <button class="btn btn-outline" style="padding:4px 10px;font-size:0.77rem;white-space:nowrap;color:#d03030;border-color:#d03030;" onclick="deleteTemplate()">å‰Šé™¤</button>
      </div>
      <table class="cartbl">
        <thead>
          <tr>
            <th style="width:54px;">å·è»Š</th>
            <th>åº§å¸­ã‚¯ãƒ©ã‚¹</th>
            <th style="width:78px;">å®šå“¡æ•°</th>
            <th>ä½ç½®ãƒ¡ãƒ¢</th>
            <th style="width:72px;"></th>
          </tr>
        </thead>
        <tbody>${renderCars(t.cars||[])}</tbody>
      </table>
      <button class="btn-add-car" onclick="addCar()">ï¼‹ å·è»Šã‚’è¿½åŠ </button>

      <div class="editor-actions">
        <button class="btn-del" onclick="deleteTrain()">ğŸ—‘ ã“ã®åˆ—è»Šã‚’å‰Šé™¤</button>
      </div>
    </div>
  `;
}

function renderStops(stops) {
  if (stops.length === 0) {
    return '<tr><td colspan="5" style="text-align:center;padding:18px;color:#bbb;font-size:0.8rem;">åœè»Šé§…ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
  }

  return stops.map((s, i) => {
    const isFirst = i === 0;
    const isLast  = i === stops.length - 1;
    const opts = Object.entries(STATION_REGISTRY).map(([code, st]) =>
      `<option value="${code}"${s.code===code?' selected':''}>${st.name}${st.numbered?' ['+code+']':''}</option>`
    ).join('');
    return `
      <tr>
        <td style="text-align:center;color:#ccc;font-size:0.74rem;">${i + 1}</td>
        <td><select onchange="setStop(${i},'code',this.value)">${opts}</select></td>
        <td><input type="time" value="${s.arr||''}"
          ${isFirst ? 'disabled' : ''}
          onchange="setStop(${i},'arr',this.value||null)"></td>
        <td><input type="time" value="${s.dep||''}"
          ${isLast ? 'disabled' : ''}
          onchange="setStop(${i},'dep',this.value||null)"></td>
        <td style="text-align:center;white-space:nowrap;">
          <button class="ico" onclick="moveStop(${i},-1)" ${isFirst?'disabled':''} title="ä¸Šã¸">â†‘</button>
          <button class="ico" onclick="moveStop(${i}, 1)" ${isLast ?'disabled':''} title="ä¸‹ã¸">â†“</button>
          <button class="ico del" onclick="removeStop(${i})" title="å‰Šé™¤">âœ•</button>
        </td>
      </tr>`;
  }).join('');
}

// =============================================================================
// ãƒ‡ãƒ¼ã‚¿æ“ä½œ
// =============================================================================
function setField(key, val) {
  const t = currentTrain();
  if (!t) return;
  t[key] = val;
  saveState();
  renderList();
}

function setStop(idx, key, val) {
  const t = currentTrain();
  if (!t) return;
  t.stops[idx][key] = val || null;
  saveState();
}

function addStop() {
  const t = currentTrain();
  if (!t) return;
  t.stops.push({ code: 'A1', arr: null, dep: null });
  saveState();
  renderEditor();
}

function removeStop(idx) {
  const t = currentTrain();
  if (!t) return;
  t.stops.splice(idx, 1);
  saveState();
  renderEditor();
}

function moveStop(idx, dir) {
  const t = currentTrain();
  if (!t) return;
  const j = idx + dir;
  if (j < 0 || j >= t.stops.length) return;
  [t.stops[idx], t.stops[j]] = [t.stops[j], t.stops[idx]];
  saveState();
  renderEditor();
}

// =============================================================================
// ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ / ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
// =============================================================================
function buildCode() {
  const now = new Date().toLocaleString('ja-JP');
  const data = { trains: state.trains };
  return `// js/timetable-data.js\n// eã‚‹ã‚Šãã‚…ã† æ™‚åˆ»è¡¨ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  å‡ºåŠ› ${now}\n// â€» æ‰‹å‹•ç·¨é›†ã‚ˆã‚Šç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  (admin.html) ã®ä½¿ç”¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚\n\nconst TIMETABLE = ${JSON.stringify(data, null, 2)};\n`;
}

function exportFile() {
  const blob = new Blob([buildCode()], { type: 'text/javascript' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'timetable-data.js';
  a.click();
  showToast('timetable-data.js ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ');
}

function copyCode() {
  navigator.clipboard.writeText(buildCode())
    .then(() => showToast('ã‚³ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'));
}

function openImport() {
  document.getElementById('import-ta').value = '';
  document.getElementById('import-modal').classList.add('open');
}

function closeImport() {
  document.getElementById('import-modal').classList.remove('open');
}

function doImport() {
  const text = document.getElementById('import-ta').value.trim();
  try {
    let data;
    if (text.startsWith('{')) {
      // ç”Ÿ JSON
      data = JSON.parse(text);
    } else {
      // JS ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼
      const m = text.match(/const\s+TIMETABLE\s*=\s*(\{[\s\S]*\})\s*;?\s*$/);
      if (!m) throw new Error('å½¢å¼ãŒèªè­˜ã§ãã¾ã›ã‚“ã€‚å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãã®ã¾ã¾è²¼ã‚Šä»˜ã‘ã‚‹ã‹ã€JSON å½¢å¼ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
      data = JSON.parse(m[1]);
    }
    if (!Array.isArray(data.trains)) throw new Error('trains ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
    state = data;
    saveState();
    currentId = null;
    renderList();
    closeImport();
    document.getElementById('adm-main').innerHTML =
      `<div class="empty-hint"><h3>ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†</h3><p>${state.trains.length}æœ¬ã®åˆ—è»Šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚å·¦ã®ãƒªã‚¹ãƒˆã‹ã‚‰é¸ã‚“ã§ãã ã•ã„ã€‚</p></div>`;
    showToast(`${state.trains.length}æœ¬ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ`);
  } catch (e) {
    alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ:\n' + e.message);
  }
}

// =============================================================================
// ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
// =============================================================================
function dayLabel(d) {
  if (Array.isArray(d)) {
    if (d.length === 0) return 'æŒ‡å®šæ—¥ãªã—';
    if (d.length === 1) return d[0];
    return `${d.length}æ—¥é–“ï¼ˆæŒ‡å®šï¼‰`;
  }
  return d === 'weekday' ? 'å¹³æ—¥' : d === 'weekend' ? 'ä¼‘æ—¥' : 'æ¯æ—¥';
}

function onRunDaysTypeChange(val) {
  const t = currentTrain();
  if (!t) return;
  const wrap = document.getElementById('f-specific-wrap');
  if (val === 'specific') {
    wrap.style.display = 'flex';
    if (!Array.isArray(t.runDays)) { t.runDays = []; saveState(); }
  } else {
    wrap.style.display = 'none';
    t.runDays = val;
    saveState();
    renderList();
  }
}

function addDate() {
  const t = currentTrain();
  if (!t || !Array.isArray(t.runDays)) return;
  const input = document.getElementById('f-date-add');
  const date  = input.value;
  if (!date) { showToast('æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
  if (t.runDays.includes(date)) { showToast('ã™ã§ã«è¿½åŠ ã•ã‚Œã¦ã„ã¾ã™'); return; }
  t.runDays.push(date);
  t.runDays.sort();
  saveState();
  renderList();
  document.getElementById('f-date-chips').innerHTML =
    t.runDays.map(d => `<span class="date-chip">${esc(d)}<button class="date-chip-del" onclick="removeDate('${d}')">âœ•</button></span>`).join('');
  input.value = '';
}

function removeDate(date) {
  const t = currentTrain();
  if (!t || !Array.isArray(t.runDays)) return;
  t.runDays = t.runDays.filter(d => d !== date);
  saveState();
  renderList();
  document.getElementById('f-date-chips').innerHTML =
    t.runDays.map(d => `<span class="date-chip">${esc(d)}<button class="date-chip-del" onclick="removeDate('${d}')">âœ•</button></span>`).join('');
}

// =============================================================================
// ç·¨æˆãƒ»åº§å¸­ CRUD
// =============================================================================
function renderCars(cars) {
  if (!cars || cars.length === 0) {
    return '<tr><td colspan="5" style="text-align:center;padding:14px;color:#bbb;font-size:0.8rem;">å·è»ŠãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</td></tr>';
  }
  return cars.map((c, i) => `
    <tr>
      <td><input type="number" min="1" max="99" value="${c.carNo||i+1}" style="text-align:center;" onchange="setCar(${i},'carNo',+this.value)"></td>
      <td>
        <select onchange="setCar(${i},'seatClass',this.value)">
          <option value="general"  ${c.seatClass==='general'  ?'selected':''}>ä¸€èˆ¬è»Š</option>
          <option value="free"     ${c.seatClass==='free'     ?'selected':''}>è‡ªç”±å¸­ï¼ˆäºŒç­‰ï¼‰</option>
          <option value="reserved" ${c.seatClass==='reserved' ?'selected':''}>äºŒç­‰æŒ‡å®šå¸­</option>
          <option value="special"  ${c.seatClass==='special'  ?'selected':''}>ç‰¹åˆ¥è»Š</option>
        </select>
      </td>
      <td><input type="number" min="0" max="999" value="${c.seats||0}" style="text-align:center;" onchange="setCar(${i},'seats',+this.value)"></td>
      <td><input type="text" value="${esc(c.note||'')}" placeholder="ä¾‹: ç¦ç…™ãƒ»å‰å¯„ã‚Š" oninput="setCar(${i},'note',this.value)"></td>
      <td style="text-align:center;white-space:nowrap;">
        <button class="ico" onclick="moveCar(${i},-1)" ${i===0?'disabled':''} title="ä¸Šã¸">â†‘</button>
        <button class="ico" onclick="moveCar(${i}, 1)" ${i===cars.length-1?'disabled':''} title="ä¸‹ã¸">â†“</button>
        <button class="ico del" onclick="removeCar(${i})" title="å‰Šé™¤">âœ•</button>
      </td>
    </tr>`).join('');
}

function addCar() {
  const t = currentTrain(); if (!t) return;
  if (!t.cars) t.cars = [];
  t.cars.push({ carNo: t.cars.length + 1, seatClass: 'reserved', seats: 56, note: '' });
  saveState(); renderEditor();
}
function removeCar(idx) {
  const t = currentTrain(); if (!t || !t.cars) return;
  t.cars.splice(idx, 1); saveState(); renderEditor();
}
function moveCar(idx, dir) {
  const t = currentTrain(); if (!t || !t.cars) return;
  const j = idx + dir; if (j < 0 || j >= t.cars.length) return;
  [t.cars[idx], t.cars[j]] = [t.cars[j], t.cars[idx]]; saveState(); renderEditor();
}
function setCar(idx, key, val) {
  const t = currentTrain(); if (!t || !t.cars) return;
  t.cars[idx][key] = val; saveState();
}

// =============================================================================
// ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç†
// =============================================================================
const TMPL_KEY = 'kznm-car-templates';
function getTemplates() {
  try { return JSON.parse(localStorage.getItem(TMPL_KEY)) || []; } catch { return []; }
}
function saveTemplate() {
  const t = currentTrain(); if (!t) return;
  const cars = t.cars || [];
  if (cars.length === 0) { showToast('å·è»ŠãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“'); return; }
  const name = prompt('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', t.name || '');
  if (!name || !name.trim()) return;
  const nm = name.trim();
  const list = getTemplates();
  const idx  = list.findIndex(tp => tp.name === nm);
  const entry = { name: nm, cars: JSON.parse(JSON.stringify(cars)) };
  if (idx >= 0) { if (!confirm(`ã€Œ${nm}ã€ã‚’ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ`)) return; list[idx] = entry; }
  else list.push(entry);
  localStorage.setItem(TMPL_KEY, JSON.stringify(list));
  showToast(`ã€Œ${nm}ã€ã‚’ä¿å­˜ã—ã¾ã—ãŸ`); renderEditor();
}
function loadTemplate() {
  const t = currentTrain(); if (!t) return;
  const sel = document.getElementById('f-tmpl');
  if (!sel || !sel.value) { showToast('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
  const tp = getTemplates().find(tp => tp.name === sel.value); if (!tp) return;
  if (!confirm(`ç¾åœ¨ã®ç·¨æˆã‚’ã€Œ${tp.name}ã€ã§ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ`)) return;
  t.cars = JSON.parse(JSON.stringify(tp.cars));
  saveState(); renderEditor(); showToast(`ã€Œ${tp.name}ã€ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
}
function deleteTemplate() {
  const sel = document.getElementById('f-tmpl');
  if (!sel || !sel.value) { showToast('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
  if (!confirm(`ã€Œ${sel.value}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
  localStorage.setItem(TMPL_KEY, JSON.stringify(getTemplates().filter(tp => tp.name !== sel.value)));
  showToast('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸ'); renderEditor();
}

// =============================================================================
// GitHub ä¸€æ‹¬åŒæœŸ
// =============================================================================

// åŒæœŸå¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆtimetable-data.js ã¯å‹•çš„ç”Ÿæˆã®ãŸã‚åˆ¥æ‰±ã„ï¼‰
const SITE_FILES = [
  'index.html', 'about.html', 'contact.html', 'news.html',
  'privacy.html', 'services.html', 'reservation.html', 'admin.html',
  'css/style.css',
  'js/main.js', 'js/reservation.js',
  'images/favicon.svg', 'images/placeholder.svg',
  'images/arlate.jpg', 'images/japan.gif', 'images/palau.png', 'images/taiwan.png',
];

// ArrayBuffer â†’ base64ï¼ˆå¤§ãã„ãƒ•ã‚¡ã‚¤ãƒ«å¯¾å¿œï¼‰
function _toBase64(buffer) {
  const bytes = new Uint8Array(buffer);
  let binary = '';
  for (let i = 0; i < bytes.byteLength; i++) binary += String.fromCharCode(bytes[i]);
  return btoa(binary);
}

let _autoSyncTimer = null;

function _scheduleAutoSync() {
  const radio = document.querySelector('input[name="gh-autosync"]:checked');
  if (!radio || radio.value !== 'always') return;
  clearTimeout(_autoSyncTimer);
  _autoSyncTimer = setTimeout(_syncTimetableOnly, 2000);
}

// å¸¸æ™‚åŒæœŸç”¨ï¼šæ™‚åˆ»è¡¨ãƒ‡ãƒ¼ã‚¿ + äºˆç´„ãƒ‡ãƒ¼ã‚¿ã‚’è‡ªå‹•æ›´æ–°
async function _syncTimetableOnly() {
  const owner  = localStorage.getItem('gh-owner')  || '';
  const repo   = localStorage.getItem('gh-repo')   || '';
  const pat    = localStorage.getItem('gh-pat')    || '';
  if (!owner || !repo || !pat) return;

  const statusEl = document.getElementById('save-status');
  statusEl.textContent = 'GitHubåŒæœŸä¸­...';

  const headers = { 'Authorization': `token ${pat}`, 'Accept': 'application/vnd.github.v3+json', 'Content-Type': 'application/json' };

  // åŒæœŸã™ã‚‹2ãƒ•ã‚¡ã‚¤ãƒ«
  const autoFiles = [
    { path: 'js/timetable-data.js',    content: buildCode() },
    { path: 'data/reservations.json',  content: localStorage.getItem(RESV_KEY) || '{"reservations":[]}' },
  ];

  try {
    const msg = `æ™‚åˆ»è¡¨ãƒ»äºˆç´„ãƒ‡ãƒ¼ã‚¿ã‚’è‡ªå‹•æ›´æ–° [${new Date().toLocaleString('ja-JP')}]`;
    for (const file of autoFiles) {
      const b64    = _toBase64(new TextEncoder().encode(file.content).buffer);
      const getRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${file.path}`, { headers });
      const sha    = getRes.ok ? (await getRes.json()).sha : undefined;
      const body   = { message: msg, content: b64 };
      if (sha) body.sha = sha;
      await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${file.path}`, {
        method: 'PUT', headers, body: JSON.stringify(body),
      });
    }
    const t = new Date();
    statusEl.textContent = `GitHubåŒæœŸæ¸ˆã¿ ${t.getHours()}:${String(t.getMinutes()).padStart(2,'0')}`;
  } catch {
    statusEl.textContent = 'GitHubåŒæœŸå¤±æ•—';
  }
}

function toggleGhPanel() {
  document.getElementById('gh-panel').classList.toggle('open');
}
function saveGhConfig() {
  localStorage.setItem('gh-owner',  document.getElementById('gh-owner').value.trim());
  localStorage.setItem('gh-repo',   document.getElementById('gh-repo').value.trim());
  localStorage.setItem('gh-branch', document.getElementById('gh-branch').value.trim() || 'main');
  localStorage.setItem('gh-pat',    document.getElementById('gh-pat').value.trim());
  const checked = document.querySelector('input[name="gh-autosync"]:checked');
  localStorage.setItem('gh-autosync', checked ? checked.value : 'off');
}
function loadGhConfig() {
  const el = (id) => document.getElementById(id);
  el('gh-owner').value  = localStorage.getItem('gh-owner')  || '';
  el('gh-repo').value   = localStorage.getItem('gh-repo')   || '';
  el('gh-branch').value = localStorage.getItem('gh-branch') || 'main';
  el('gh-pat').value    = localStorage.getItem('gh-pat')    || '';
  const saved = localStorage.getItem('gh-autosync') || 'off';
  const radio = document.querySelector(`input[name="gh-autosync"][value="${saved}"]`);
  if (radio) radio.checked = true;
}

// æ‰‹å‹•ãƒœã‚¿ãƒ³ç”¨ï¼šå…¨ã‚µã‚¤ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸€æ‹¬åŒæœŸ
async function syncToGitHub() {
  const owner  = localStorage.getItem('gh-owner')  || '';
  const repo   = localStorage.getItem('gh-repo')   || '';
  const branch = localStorage.getItem('gh-branch') || 'main';
  const pat    = localStorage.getItem('gh-pat')    || '';
  if (!owner || !repo || !pat) {
    document.getElementById('gh-panel').classList.add('open');
    showToast('GitHubè¨­å®šã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    return;
  }

  const btn = document.getElementById('gh-sync-btn');
  btn.classList.add('syncing');
  btn.textContent = 'æ¥ç¶šä¸­...';

  const h = {
    'Authorization': `token ${pat}`,
    'Accept': 'application/vnd.github.v3+json',
    'Content-Type': 'application/json',
  };

  try {
    // 1. HEAD ã‚³ãƒŸãƒƒãƒˆå–å¾—
    const refRes = await fetch(
      `https://api.github.com/repos/${owner}/${repo}/git/ref/heads/${branch}`, { headers: h });
    if (!refRes.ok) throw new Error(`ãƒ–ãƒ©ãƒ³ãƒ "${branch}" ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆ${refRes.status}ï¼‰`);
    const baseCommitSha = (await refRes.json()).object.sha;

    // 2. ãƒ™ãƒ¼ã‚¹ãƒ„ãƒªãƒ¼ SHA å–å¾—
    const cRes = await fetch(
      `https://api.github.com/repos/${owner}/${repo}/git/commits/${baseCommitSha}`, { headers: h });
    const baseTreeSha = (await cRes.json()).tree.sha;

    // 3. å„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ fetch ã—ã¦ blob ä½œæˆ
    const allPaths = ['js/timetable-data.js', 'js/gh-sync-config.js', ...SITE_FILES];
    const treeItems = [];
    let done = 0;

    for (const path of allPaths) {
      btn.textContent = `ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†ä¸­â€¦ ${++done} / ${allPaths.length}`;
      try {
        let b64;
        if (path === 'js/timetable-data.js') {
          // æ™‚åˆ»è¡¨ãƒ‡ãƒ¼ã‚¿ã¯ localStorage ã‹ã‚‰å‹•çš„ç”Ÿæˆ
          b64 = _toBase64(new TextEncoder().encode(buildCode()).buffer);
        } else if (path === 'js/gh-sync-config.js') {
          // äºˆç´„åŒæœŸç”¨ GitHub è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆreservation.html ã‹ã‚‰åˆ©ç”¨ï¼‰
          const cfg = JSON.stringify({
            owner: localStorage.getItem('gh-owner')  || '',
            repo:  localStorage.getItem('gh-repo')   || '',
            branch: localStorage.getItem('gh-branch') || 'main',
            pat:   localStorage.getItem('gh-pat')    || '',
          });
          const src = `// è‡ªå‹•ç”Ÿæˆ â€” admin.html ã‹ã‚‰åŒæœŸã•ã‚Œã¾ã—ãŸ\n// âš  ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯èªè¨¼æƒ…å ±ãŒå«ã¾ã‚Œã¾ã™ã€‚å…¬é–‹ãƒªãƒã‚¸ãƒˆãƒªã§ã¯å–ã‚Šæ‰±ã„ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚\nconst GH_SYNC_CONFIG = ${cfg};\n`;
          b64 = _toBase64(new TextEncoder().encode(src).buffer);
        } else {
          const res = await fetch(path);
          if (!res.ok) continue; // å­˜åœ¨ã—ãªã„ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚¹ã‚­ãƒƒãƒ—
          b64 = _toBase64(await res.arrayBuffer());
        }
        const blobRes = await fetch(
          `https://api.github.com/repos/${owner}/${repo}/git/blobs`,
          { method: 'POST', headers: h, body: JSON.stringify({ content: b64, encoding: 'base64' }) }
        );
        if (!blobRes.ok) continue;
        treeItems.push({ path, mode: '100644', type: 'blob', sha: (await blobRes.json()).sha });
      } catch { /* ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ— */ }
    }

    if (treeItems.length === 0) throw new Error('åŒæœŸã§ãã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ');

    // 4. æ–°ã—ã„ãƒ„ãƒªãƒ¼ã‚’ä½œæˆ
    btn.textContent = 'ã‚³ãƒŸãƒƒãƒˆä½œæˆä¸­...';
    const treeRes = await fetch(
      `https://api.github.com/repos/${owner}/${repo}/git/trees`,
      { method: 'POST', headers: h, body: JSON.stringify({ base_tree: baseTreeSha, tree: treeItems }) }
    );
    const newTreeSha = (await treeRes.json()).sha;

    // 5. ã‚³ãƒŸãƒƒãƒˆã‚’ä½œæˆ
    const commitRes = await fetch(
      `https://api.github.com/repos/${owner}/${repo}/git/commits`,
      { method: 'POST', headers: h, body: JSON.stringify({
        message: `ã‚µã‚¤ãƒˆä¸€æ‹¬æ›´æ–° (${treeItems.length}ãƒ•ã‚¡ã‚¤ãƒ«) [admin ${new Date().toLocaleString('ja-JP')}]`,
        tree: newTreeSha,
        parents: [baseCommitSha],
      })}
    );
    const newCommitSha = (await commitRes.json()).sha;

    // 6. ãƒ–ãƒ©ãƒ³ãƒå‚ç…§ã‚’æ›´æ–°ï¼ˆforce: true ã§é fast-forward ã§ã‚‚å¼·åˆ¶æ›´æ–°ï¼‰
    const updateRes = await fetch(
      `https://api.github.com/repos/${owner}/${repo}/git/refs/heads/${branch}`,
      { method: 'PATCH', headers: h, body: JSON.stringify({ sha: newCommitSha, force: true }) }
    );
    if (!updateRes.ok) {
      const errBody = await updateRes.json().catch(() => ({}));
      throw new Error(`ãƒ–ãƒ©ãƒ³ãƒã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ (${updateRes.status}): ${errBody.message || ''}`);
    }

    showToast(`${treeItems.length}ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ GitHub ã«åŒæœŸã—ã¾ã—ãŸï¼`);
  } catch (e) {
    alert('åŒæœŸã«å¤±æ•—ã—ã¾ã—ãŸ:\n' + e.message);
  } finally {
    btn.textContent = 'ğŸ”„ GitHub ã«åŒæœŸ'; btn.classList.remove('syncing');
  }
}

function adminTypeInfo(type) {
  const map = {
    express:          { label: 'ç‰¹æ€¥',        color: '#1c3a6e' },
    rapid:            { label: 'æ€¥è¡Œ',        color: '#4a7ab5' },
    'special-rapid':  { label: 'ç‰¹åˆ¥å¿«é€Ÿ',    color: '#1a6b4a' },
    'holiday-rapid':  { label: 'ï¾ï¾˜ï¾ƒï¾ï½°å¿«é€Ÿ',  color: '#c27b08' },
    charter:          { label: 'è‡¨æ™‚ï¼ˆå›£ä½“ï¼‰', color: '#7b3fa0' },
  };
  return map[type] || { label: type, color: '#888' };
}

// åˆ—è»Šå˜ä½“ï¼ˆæ™‚åˆ»è¡¨ãƒ‡ãƒ¼ã‚¿ã®ã¿ï¼‰ã‚’ GitHub ã«åŒæœŸ
async function syncThisTrain(btn) {
  const owner  = localStorage.getItem('gh-owner')  || '';
  const repo   = localStorage.getItem('gh-repo')   || '';
  const pat    = localStorage.getItem('gh-pat')    || '';
  if (!owner || !repo || !pat) {
    document.getElementById('gh-panel').classList.add('open');
    showToast('GitHubè¨­å®šã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return;
  }
  const orig = btn.textContent;
  btn.textContent = 'åŒæœŸä¸­...'; btn.disabled = true;

  const path    = 'js/timetable-data.js';
  const b64     = _toBase64(new TextEncoder().encode(buildCode()).buffer);
  const headers = { 'Authorization': `token ${pat}`, 'Accept': 'application/vnd.github.v3+json', 'Content-Type': 'application/json' };
  try {
    const getRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, { headers });
    const sha    = getRes.ok ? (await getRes.json()).sha : undefined;
    const body   = { message: `æ™‚åˆ»è¡¨ã‚’æ›´æ–° [admin ${new Date().toLocaleString('ja-JP')}]`, content: b64 };
    if (sha) body.sha = sha;
    const putRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
      method: 'PUT', headers, body: JSON.stringify(body),
    });
    if (putRes.ok) {
      btn.textContent = 'âœ“ åŒæœŸå®Œäº†';
      setTimeout(() => { btn.textContent = orig; btn.disabled = false; }, 2500);
    } else {
      const err = await putRes.json().catch(() => ({}));
      alert('åŒæœŸã«å¤±æ•—ã—ã¾ã—ãŸ:\n' + (err.message || putRes.status));
      btn.textContent = orig; btn.disabled = false;
    }
  } catch (e) {
    alert('åŒæœŸã«å¤±æ•—ã—ã¾ã—ãŸ:\n' + e.message);
    btn.textContent = orig; btn.disabled = false;
  }
}

function toggleCharterPass(type) {
  const row  = document.getElementById('charter-pass-row');
  const supRow = document.getElementById('charter-supplement-row');
  if (row)    row.style.display    = type === 'charter' ? 'grid' : 'none';
  if (supRow) supRow.style.display = type === 'charter' ? 'grid' : 'none';
}

function setNestedField(parent, key, val) {
  const t = currentTrain(); if (!t) return;
  if (!t[parent] || typeof t[parent] !== 'object') t[parent] = {};
  t[parent][key] = val;
  saveState();
}

function toggleReserveOpen() {
  const t = currentTrain();
  if (!t) return;
  t.reserveOpen = !t.reserveOpen;
  saveState();
  _syncTimetableOnly(); // ç· åˆ‡ãƒ»é–‹æ”¾ã¯å³æ™‚åŒæœŸï¼ˆå¸¸æ™‚ãƒ¢ãƒ¼ãƒ‰è¨­å®šã«é–¢ã‚ã‚‰ãšï¼‰
  // ãƒãƒƒã‚¸ã¨ãƒœã‚¿ãƒ³ã‚’ãã®å ´ã§æ›´æ–°
  const badge = document.getElementById('reserve-status-badge');
  const btn   = document.getElementById('reserve-toggle-btn');
  if (badge) {
    badge.textContent = t.reserveOpen ? 'â— äºˆç´„å—ä»˜ä¸­' : 'â—‹ å—ä»˜åœæ­¢ä¸­';
    badge.style.cssText = `font-size:0.78rem; font-weight:700; letter-spacing:0.06em; padding:4px 12px; border-radius:20px; ${t.reserveOpen ? 'background:#d4f0dc; color:#1a7a3a;' : 'background:#f0f0f0; color:#999;'}`;
  }
  if (btn) {
    btn.textContent = t.reserveOpen ? 'äºˆç´„ã‚’ã€†åˆ‡ã‚‹' : 'äºˆç´„ã‚’è§£æ”¾ã™ã‚‹';
    btn.style.cssText = `font-size:0.8rem; padding:5px 16px; ${t.reserveOpen ? 'background:#c0392b; border-color:#c0392b; color:#fff;' : 'background:#1a7a3a; border-color:#1a7a3a; color:#fff;'}`;
  }
  renderSidebar();
}

function esc(s) {
  return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function showToast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.style.display = 'block';
  clearTimeout(el._timer);
  el._timer = setTimeout(() => { el.style.display = 'none'; }, 2500);
}

// =============================================================================
// åˆæœŸåŒ–
// =============================================================================
renderList();
loadGhConfig();

// reservation.html å´ã§äºˆç´„ãŒå…¥ã£ãŸã‚‰è‡ªå‹•åŒæœŸã‚’ãƒˆãƒªã‚¬ãƒ¼
window.addEventListener('storage', (e) => {
  if (e.key === RESV_KEY) _scheduleAutoSync();
});

// åˆå›èµ·å‹•æ™‚ã«å…¨ã‚µã‚¤ãƒˆã‚’ä¸€æ‹¬åŒæœŸï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸­1å›ã®ã¿ãƒ»5ç§’å¾Œã«å®Ÿè¡Œã—ã¦ä»–ã®è‡ªå‹•åŒæœŸã¨é‡è¤‡ã‚’é¿ã‘ã‚‹ï¼‰
if (!sessionStorage.getItem('init-sync-done')) {
  sessionStorage.setItem('init-sync-done', '1');
  setTimeout(syncToGitHub, 5000);
}
</script>
<!-- Code injected by live-server -->
<script>
	// <![CDATA[  <-- For SVG support
	if ('WebSocket' in window) {
		(function () {
			function refreshCSS() {
				var sheets = [].slice.call(document.getElementsByTagName("link"));
				var head = document.getElementsByTagName("head")[0];
				for (var i = 0; i < sheets.length; ++i) {
					var elem = sheets[i];
					var parent = elem.parentElement || head;
					parent.removeChild(elem);
					var rel = elem.rel;
					if (elem.href && typeof rel != "string" || rel.length == 0 || rel.toLowerCase() == "stylesheet") {
						var url = elem.href.replace(/(&|\?)_cacheOverride=\d+/, '');
						elem.href = url + (url.indexOf('?') >= 0 ? '&' : '?') + '_cacheOverride=' + (new Date().valueOf());
					}
					parent.appendChild(elem);
				}
			}
			var protocol = window.location.protocol === 'http:' ? 'ws://' : 'wss://';
			var address = protocol + window.location.host + window.location.pathname + '/ws';
			var socket = new WebSocket(address);
			socket.onmessage = function (msg) {
				if (msg.data == 'reload') window.location.reload();
				else if (msg.data == 'refreshcss') refreshCSS();
			};
			if (sessionStorage && !sessionStorage.getItem('IsThisFirstTime_Log_From_LiveServer')) {
				console.log('Live reload enabled.');
				sessionStorage.setItem('IsThisFirstTime_Log_From_LiveServer', true);
			}
		})();
	}
	else {
		console.error('Upgrade your browser. This Browser is NOT supported WebSocket for Live-Reloading.');
	}
	// ]]>
</script>
</body>
</html>
